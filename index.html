<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è©›å’’è¿·å®®ï¼šå¤šäººé€£ç·šç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #1e1e2e; --board: #11111b; --tile: #313244;
            --p1: #f38ba8; --p2: #89b4fa; --p3: #f9e2af; --p4: #a6e3a1;
        }
        body {
            font-family: sans-serif; background: var(--bg); color: #cdd6f4;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* --- é€£ç·šå¤§å»³ UI --- */
        #lobby {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1e1e2e; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }
        .lobby-box {
            background: #313244; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;
            box-shadow: 0 10px 30px black;
        }
        h1 { margin: 0 0 20px 0; color: #f9e2af; }
        input {
            width: 100%; padding: 15px; font-size: 1.2rem; text-align: center; letter-spacing: 5px;
            margin-bottom: 15px; border-radius: 8px; border: none; text-transform: uppercase;
        }
        .btn-lobby {
            width: 100%; padding: 15px; font-size: 1.1rem; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; margin-bottom: 10px; color: #111;
        }
        .btn-create { background: #a6e3a1; }
        .btn-join { background: #89b4fa; }
        #room-id-display { font-size: 3rem; font-family: monospace; color: #f9e2af; margin: 20px 0; letter-spacing: 5px; font-weight: bold;}
        .player-list { text-align: left; margin-top: 20px; color: #bac2de; }
        .p-item { padding: 5px 0; border-bottom: 1px solid #45475a; }

        /* --- éŠæˆ²å…§ UI --- */
        #game-ui { display: none; flex-direction: column; height: 100%; }
        header { padding: 10px; background: rgba(0,0,0,0.4); display: flex; justify-content: space-between; align-items: center;}
        .game-area { flex: 1; display: flex; align-items: center; justify-content: center; }
        .board {
            display: grid; width: 94vw; height: 94vw; max-width: 500px; max-height: 500px;
            grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr);
            gap: 2px; padding: 4px; background: var(--board); border-radius: 8px;
        }
        .tile { position: relative; background: var(--tile); border-radius: 4px; transition: transform 0.2s; }
        .tile.selected { box-shadow: 0 0 0 3px #89b4fa; z-index: 5; background: #45475a; }
        .tile.overheat { border: 2px dashed #fab387; opacity: 0.5; }
        .tile.locked { border: 2px solid #f38ba8; }
        .tile.locked::after { content:"ğŸ”’"; position:absolute; right:1px; top:1px; font-size:10px; }
        
        .path { position: absolute; background: #bac2de; }
        .path.c { width:40%; height:40%; top:30%; left:30%; }
        .path.n { width:40%; height:35%; top:0; left:30%; }
        .path.s { width:40%; height:35%; bottom:0; left:30%; }
        .path.w { width:35%; height:40%; left:0; top:30%; }
        .path.e { width:35%; height:40%; right:0; top:30%; }
        
        .tile.goal .path { background: #f9e2af; }
        .tile.portal .path { background: #89b4fa; }
        .tile.curse .path { background: #cba6f7; }
        .icon { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:6; font-size:1.2rem; pointer-events:none;}

        .player { position: absolute; width:16%; height:16%; border-radius:50%; z-index:20; border:2px solid #fff; transition:all 0.3s; pointer-events:none; }
        .p0{background:var(--p1);} .p1{background:var(--p2);} .p2{background:var(--p3);} .p3{background:var(--p4);}

        .controls { padding: 15px; background: #181825; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; gap: 10px; }
        .status-bar { display: flex; justify-content: space-between; color: #a6adc8; font-size: 0.9rem; }
        .msg { text-align: center; color: #fab387; min-height: 1.4em; }
        button.game-btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-act { background: #a6e3a1; color: #111; }
        .btn-pass { background: #f38ba8; color: #111; }
        .btn-disabled { background: #45475a; color: #777; cursor: not-allowed; }

        /* é®ç½©ï¼šä¸æ˜¯ä½ çš„å›åˆæ™‚ */
        #wait-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 900;
            display: none; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem; font-weight: bold; flex-direction: column;
        }
    </style>
</head>
<body>

<div id="lobby">
    <div class="lobby-box" id="lobby-start">
        <h1>è©›å’’è¿·å®®<br><small>å¤šäººé€£ç·šç‰ˆ</small></h1>
        <button class="btn-lobby btn-create" onclick="createRoom()">ğŸ  å‰µå»ºæˆ¿é–“ (æˆ¿ä¸»)</button>
        <button class="btn-lobby btn-join" onclick="showJoin()">ğŸ”— åŠ å…¥æˆ¿é–“ (ç©å®¶)</button>
    </div>

    <div class="lobby-box" id="lobby-host" style="display:none;">
        <h3>æˆ¿é–“ ID</h3>
        <div id="room-id-display">...</div>
        <p>è«‹å°‡æ­¤ ID å‘Šè¨´æœ‹å‹</p>
        <div class="player-list" id="host-list">
            <div class="p-item">P1 (æˆ¿ä¸») - å·²å°±ç·’</div>
        </div>
        <button class="btn-lobby btn-create" style="margin-top:20px;" onclick="hostStartGame()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div class="lobby-box" id="lobby-join" style="display:none;">
        <h3>è¼¸å…¥æˆ¿é–“ ID</h3>
        <input type="text" id="input-room-id" placeholder="ä¾‹å¦‚: ABCD" maxlength="4">
        <button class="btn-lobby btn-join" onclick="joinRoom()">é€£ç·š</button>
        <button class="btn-lobby" style="background:#45475a; color:#fff;" onclick="location.reload()">è¿”å›</button>
        <div id="join-status" style="margin-top:10px; color:#f9e2af;"></div>
    </div>
</div>

<div id="game-ui">
    <div id="wait-mask">
        <div>ç­‰å¾…å°æ‰‹è¡Œå‹•...</div>
        <div style="font-size:1rem; margin-top:10px; color:#aaa;" id="wait-msg"></div>
    </div>

    <header>
        <span id="my-role">æˆ‘æ˜¯: P1</span>
        <span style="background:#fff; color:#000; padding:2px 8px; border-radius:10px;" id="turn-badge">P1 å›åˆ</span>
    </header>

    <div class="game-area">
        <div class="board" id="board"></div>
    </div>

    <div class="controls">
        <div class="status-bar">
            <span id="phase-txt">éšæ®µï¼šæ—‹è½‰</span>
            <span id="count-txt" style="color:#a6e3a1; font-weight:bold;">0/2</span>
        </div>
        <div class="msg" id="msg">ç­‰å¾…é–‹å§‹...</div>
        <div style="display:flex; gap:10px;">
            <button class="game-btn btn-act" id="btn-main" onclick="myAction('CONFIRM')">å®Œæˆæ—‹è½‰</button>
            <button class="game-btn btn-pass" id="btn-sub" onclick="myAction('END')">çµæŸå›åˆ</button>
        </div>
    </div>
</div>

<script>
    // --- åƒæ•¸ ---
    const SIZE = 5;
    const TILES = { I:[1,0,1,0], L:[0,1,1,0], T:[1,1,1,0], X:[1,1,1,1] };
    const COLORS = ['#f38ba8', '#89b4fa', '#f9e2af', '#a6e3a1'];

    // --- é€£ç·šè®Šæ•¸ ---
    let peer = null;
    let myId = null;
    let connections = []; // æˆ¿ä¸»å­˜æ‰€æœ‰é€£ç·š
    let hostConn = null;  // ç©å®¶å­˜æˆ¿ä¸»é€£ç·š
    let isHost = false;
    let myPlayerIndex = -1; // 0~3
    
    // --- éŠæˆ²ç‹€æ…‹ (ç”±æˆ¿ä¸»ç¶­è­·ä¸¦å»£æ’­) ---
    let gameState = {
        board: [],
        players: [],
        currP: 0,
        phase: 'ROTATE', // ROTATE, MOVE, LOCK
        movesLeft: 0,
        rotatedTiles: [], // {x,y}
        overheated: [],   // {x,y}
        turnCount: 0
    };

    // ==========================================
    // PeerJS é€£ç·šé‚è¼¯
    // ==========================================

    function generateId() {
        // ç”¢ç”Ÿ 4 ä½å¤§å¯«äº‚æ•¸ ID
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let res = "";
        for(let i=0; i<4; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
        return res;
    }

    function createRoom() {
        const roomId = generateId();
        initPeer(roomId);
        isHost = true;
        myPlayerIndex = 0;
        
        document.getElementById('lobby-start').style.display = 'none';
        document.getElementById('lobby-host').style.display = 'block';
        document.getElementById('room-id-display').innerText = roomId;
    }

    function showJoin() {
        document.getElementById('lobby-start').style.display = 'none';
        document.getElementById('lobby-join').style.display = 'block';
    }

    function joinRoom() {
        const inputId = document.getElementById('input-room-id').value.toUpperCase();
        if(inputId.length < 4) return alert("è«‹è¼¸å…¥ 4 ä½æˆ¿è™Ÿ");
        
        document.getElementById('join-status').innerText = "é€£ç·šä¸­...";
        initPeer(null); // ç©å®¶ä¸éœ€è¦å›ºå®šIDï¼Œè‡ªå‹•ç”Ÿæˆ
        
        // ç­‰å¾… Peer Ready å¾Œå†é€£ç·š
        peer.on('open', (id) => {
            console.log("My Peer ID:", id);
            hostConn = peer.connect('CM-' + inputId);
            
            hostConn.on('open', () => {
                document.getElementById('join-status').innerText = "å·²é€£ä¸Šæˆ¿ä¸»ï¼ç­‰å¾…é–‹å§‹...";
                // å‚³é€åŠ å…¥è«‹æ±‚
                hostConn.send({ type: 'JOIN' });
            });

            hostConn.on('data', (data) => handleData(data));
            
            hostConn.on('close', () => {
                alert("æˆ¿ä¸»å·²æ–·ç·š");
                location.reload();
            });
        });
    }

    function initPeer(customId) {
        // ä½¿ç”¨ 'CM-' å‰ç¶´é¿å…èˆ‡å…¶ä»–äººé‡è¤‡
        let opts = customId ? { host:'0.peerjs.com', port:443, path:'/', key:'peerjs', debug:2 } : {debug:2};
        if(customId) opts.peerId = 'CM-' + customId; // æŒ‡å®š ID

        // ä½¿ç”¨å…è²»å…¬ç”¨ Server
        peer = new Peer(customId ? 'CM-'+customId : undefined);

        peer.on('open', (id) => {
            myId = id;
            console.log("Peer Open:", id);
        });

        peer.on('connection', (conn) => {
            // åªæœ‰æˆ¿ä¸»æœƒæ”¶åˆ°é€£ç·š
            if(!isHost) return;
            
            conn.on('open', () => {
                console.log("New Player Connected");
                connections.push(conn);
                
                // åˆ†é…ä½ç½® (ç°¡å–®åš: é€£é€²ä¾†å°±æ˜¯ P2, P3, P4)
                let pIndex = connections.length; // å› ç‚º P1 æ˜¯æˆ¿ä¸»ï¼Œconn 1 æ˜¯ P2
                
                // å»£æ’­æ–°çš„ç©å®¶åˆ—è¡¨
                updateLobbyList();

                conn.send({ type: 'WELCOME', pIndex: pIndex });
            });

            conn.on('data', (data) => {
                handleHostLogic(data);
            });
            
            conn.on('close', () => {
                // è™•ç†æ–·ç·š (ç•¥ï¼Œç°¡åŒ–ç‰ˆ)
            });
        });

        peer.on('error', (err) => {
            console.error(err);
            if(err.type === 'unavailable-id') alert("æ­¤æˆ¿é–“ ID å·²è¢«ä½¿ç”¨ï¼Œè«‹é‡è©¦");
            else alert("é€£ç·šéŒ¯èª¤: " + err.type);
        });
    }

    function updateLobbyList() {
        if(!isHost) return;
        let html = '<div class="p-item">P1 (æˆ¿ä¸») - æº–å‚™</div>';
        connections.forEach((c, i) => {
            html += `<div class="p-item">P${i+2} - å·²åŠ å…¥</div>`;
        });
        document.getElementById('host-list').innerHTML = html;
        
        // å¦‚æœæ»¿ 4 äºº (3å€‹é€£ç·š + æˆ¿ä¸»)
        if(connections.length >= 3) {
            // è‡ªå‹•é–‹å§‹? é‚„æ˜¯æ‰‹å‹•
        }
    }

    function hostStartGame() {
        // åˆå§‹åŒ–éŠæˆ²æ•¸æ“š
        initGameData();
        broadcastState();
    }

    // ==========================================
    // è³‡æ–™è™•ç† (æ¥æ”¶ç«¯)
    // ==========================================

    function handleData(data) {
        if(data.type === 'WELCOME') {
            myPlayerIndex = data.pIndex;
            document.getElementById('join-status').innerText = `æˆ‘æ˜¯ P${myPlayerIndex+1}ï¼Œç­‰å¾…éŠæˆ²é–‹å§‹...`;
        }
        else if(data.type === 'STATE_UPDATE') {
            // æ”¶åˆ°æœ€æ–°éŠæˆ²ç‹€æ…‹
            gameState = data.state;
            
            // å¦‚æœé‚„åœ¨å¤§å»³ï¼Œåˆ‡æ›åˆ°éŠæˆ²ç•«é¢
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            
            renderGame();
        }
    }

    // ==========================================
    // æˆ¿ä¸»é‚è¼¯æ ¸å¿ƒ (ä¼ºæœå™¨)
    // ==========================================

    function handleHostLogic(data) {
        // è™•ç†ç©å®¶å‚³ä¾†çš„æ“ä½œè«‹æ±‚
        // data = { type: 'CLICK', x: 1, y: 1, pIndex: 1 }
        
        let p = gameState.players[gameState.currP];
        
        // é©—è­‰æ˜¯å¦æ˜¯ç•¶å‰å›åˆç©å®¶
        if(data.pIndex !== gameState.currP) return; 

        if(data.type === 'CLICK') {
            let x = data.x, y = data.y;
            let t = gameState.board[y][x];
            let hasP = gameState.players.some(pl => pl.x===x && pl.y===y);

            // --- é‚è¼¯è¤‡è£½è‡ªå–®æ©Ÿç‰ˆ ---
            if(gameState.phase === 'ROTATE') {
                // æª¢æŸ¥åˆæ³•æ€§
                if(hasP || t.type==='goal' || t.lockedUntil > gameState.turnCount || isOverheated(x,y)) {
                    // éæ³•æ“ä½œï¼Œå¿½ç•¥æˆ–å›å‚³éŒ¯èª¤ (é€™è£¡ç°¡åŒ–ç‚ºå¿½ç•¥)
                    return; 
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²è½‰é2æ¬¡
                let alreadyRotated = gameState.rotatedTiles.some(r => r.x===x && r.y===y);
                if(!alreadyRotated && gameState.rotatedTiles.length >= 2) return;

                if(!alreadyRotated) gameState.rotatedTiles.push({x,y});

                t.rot = (t.rot+1)%4;
                t.conns = calcConns(t.base, t.rot);
            }
            else if(gameState.phase === 'MOVE') {
                if(gameState.movesLeft > 0 && checkMove(p.x, p.y, x, y)) {
                    p.x = x; p.y = y;
                    gameState.movesLeft--;
                    checkEffect(t);
                }
            }
            else if(gameState.phase === 'LOCK') {
                if(t.type!=='goal' && !hasP) {
                    t.lockedUntil = gameState.turnCount + 4;
                    hostEndTurn(); // ä¸Šé–å¾Œç›´æ¥çµæŸ
                    return; // ä¸‹é¢çš„å»£æ’­æœƒç”± hostEndTurn è§¸ç™¼
                }
            }
        }
        else if(data.type === 'CONFIRM') {
            // å®Œæˆæ—‹è½‰ï¼Œé€²å…¥ç§»å‹•
            if(gameState.phase === 'ROTATE') {
                 // éç†±è¨˜éŒ„
                gameState.overheated = [...gameState.rotatedTiles];
                gameState.phase = 'MOVE';
                gameState.movesLeft = 3;
            }
        }
        else if(data.type === 'END') {
            hostEndTurn();
            return;
        }

        broadcastState();
    }

    function hostEndTurn() {
        gameState.turnCount++;
        gameState.currP = (gameState.currP + 1) % 4; // é€™è£¡å‡è¨­ 4 äººï¼Œè‹¥ä¸è¶³å¯å‹•æ…‹èª¿æ•´
        // ç°¡å–®è™•ç†ï¼šè‹¥ connections ä¸å¤ ï¼Œè‡ªå‹•è·³éæ²’äººçš„? 
        // é€™è£¡å‡è¨­éƒ½åˆ°é½Šã€‚
        
        gameState.phase = 'ROTATE';
        gameState.movesLeft = 0;
        gameState.rotatedTiles = [];
        broadcastState();
    }

    function broadcastState() {
        // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œæˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±çš„ç•«é¢
        renderGame();
        
        // ç™¼é€çµ¦æ‰€æœ‰äºº
        let msg = { type: 'STATE_UPDATE', state: gameState };
        connections.forEach(c => c.send(msg));
    }

    // ==========================================
    // éŠæˆ²æ¸²æŸ“èˆ‡æ“ä½œ (å®¢æˆ¶ç«¯)
    // ==========================================

    function myAction(actType) {
        // UI æŒ‰éˆ•è§¸ç™¼
        sendAction({ type: actType });
    }

    function onTileClick(x, y) {
        // é»æ“Šè§¸ç™¼
        sendAction({ type: 'CLICK', x: x, y: y });
    }

    function sendAction(payload) {
        // é™„åŠ æˆ‘çš„ ID
        payload.pIndex = myPlayerIndex;

        if(isHost) {
            // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œç›´æ¥å‘¼å«é‚è¼¯
            handleHostLogic(payload);
        } else {
            // å¦‚æœæˆ‘æ˜¯ç©å®¶ï¼Œç™¼çµ¦æˆ¿ä¸»
            if(hostConn) hostConn.send(payload);
        }
    }

    function renderGame() {
        // æ›´æ–° UI
        document.getElementById('my-role').innerText = `æˆ‘æ˜¯: P${myPlayerIndex+1}`;
        document.getElementById('my-role').style.color = COLORS[myPlayerIndex];
        
        let pName = ['ç´…','è—','é»ƒ','ç¶ '][gameState.currP];
        document.getElementById('turn-badge').innerText = `P${gameState.currP+1} (${pName}) å›åˆ`;
        document.getElementById('turn-badge').style.color = COLORS[gameState.currP];

        // é®ç½©è™•ç†ï¼šä¸æ˜¯æˆ‘çš„å›åˆå°±æ“‹ä½
        let mask = document.getElementById('wait-mask');
        if(gameState.currP !== myPlayerIndex) {
            mask.style.display = 'flex';
            document.getElementById('wait-msg').innerText = `P${gameState.currP+1} æ­£åœ¨æ€è€ƒ...`;
        } else {
            mask.style.display = 'none';
        }

        // æ›´æ–°ç‹€æ…‹æ–‡å­—
        let phTxt = "", cnTxt = "";
        let btnMain = document.getElementById('btn-main');
        let btnSub = document.getElementById('btn-sub');
        
        if(gameState.phase==='ROTATE') {
            phTxt = "éšæ®µï¼šæ—‹è½‰"; cnTxt = `${gameState.rotatedTiles.length}/2`;
            btnMain.innerText = "å®Œæˆæ—‹è½‰ â–¶"; btnMain.className = "game-btn btn-act";
            btnSub.disabled = true; btnSub.className = "game-btn btn-disabled";
        } else if(gameState.phase==='MOVE') {
            phTxt = "éšæ®µï¼šç§»å‹•"; cnTxt = `${gameState.movesLeft} æ­¥`;
            btnMain.innerText = "ç§»å‹•ä¸­..."; btnMain.className = "game-btn btn-disabled";
            btnSub.disabled = false; btnSub.className = "game-btn btn-pass";
        } else {
            phTxt = "ç‰¹æ®Šï¼šä¸Šé–"; cnTxt = "--";
            btnMain.className = "game-btn btn-disabled";
        }
        
        document.getElementById('phase-txt').innerText = phTxt;
        document.getElementById('count-txt').innerText = cnTxt;

        // ç¹ªè£½æ£‹ç›¤
        const el = document.getElementById('board');
        el.innerHTML = '';
        gameState.board.forEach(row => row.forEach(t => {
            let div = document.createElement('div');
            div.className = `tile ${t.type}`;
            if(t.lockedUntil > gameState.turnCount) div.classList.add('locked');
            if(isOverheated(t.x, t.y)) div.classList.add('overheat');
            // æª¢æŸ¥æ˜¯å¦é¸ä¸­
            if(gameState.rotatedTiles.some(r=>r.x===t.x && r.y===t.y)) div.classList.add('selected');

            div.style.transform = `rotate(${t.rot*90}deg)`;
            div.onclick = () => onTileClick(t.x, t.y);

            let h = '<div class="path c"></div>';
            let c = t.base;
            if(c[0]) h+='<div class="path n"></div>'; if(c[1]) h+='<div class="path e"></div>';
            if(c[2]) h+='<div class="path s"></div>'; if(c[3]) h+='<div class="path w"></div>';
            
            let icon = '';
            if(t.type==='goal') icon='ğŸ’'; else if(t.type==='lock') icon='ğŸ”’';
            else if(t.type==='portal') icon='ğŸŒ€'; else if(t.type==='curse') icon='â˜ ï¸';
            if(icon) h+=`<div class="icon" style="transform:translate(-50%,-50%) rotate(-${t.rot*90}deg)">${icon}</div>`;
            
            div.innerHTML = h;
            el.appendChild(div);
        }));

        // ç¹ªè£½ç©å®¶
        document.querySelectorAll('.player').forEach(e=>e.remove());
        gameState.players.forEach((p, idx) => {
            // ç”±æ–¼ board æ˜¯ gridï¼Œæˆ‘å€‘éœ€è¦ç®—åº§æ¨™ã€‚
            // é€™è£¡å› ç‚ºæ˜¯æ¯æ¬¡é‡ç¹ªï¼Œæˆ‘å€‘ä½¿ç”¨ç°¡å–®çš„æ–¹å¼ï¼šappend åˆ°å°æ‡‰ tile ä¸Šï¼Ÿ
            // ä¸è¡Œï¼Œtile æœ‰ transform rotateï¼Œäººæœƒè·Ÿè‘—è½‰ã€‚
            // å¿…é ˆçµ•å°å®šä½åˆ° board ä¸Šã€‚
            // é€™è£¡ç°¡åŒ–ï¼šæˆ‘å€‘æŠ“ tile çš„ dom å…ƒç´ 
            setTimeout(() => { // å»¶é²ä¸€ä¸‹ç¢ºä¿ DOM å­˜åœ¨
                let tDom = document.getElementById('board').children[p.y*SIZE + p.x];
                if(tDom) {
                    let d = document.createElement('div');
                    d.className = `player p${idx}`;
                    let s = tDom.offsetWidth;
                    d.style.width = (s*0.5)+'px'; d.style.height = (s*0.5)+'px';
                    d.style.left = (tDom.offsetLeft + s*0.25)+'px';
                    d.style.top = (tDom.offsetTop + s*0.25)+'px';
                    document.getElementById('board').appendChild(d);
                }
            }, 0);
        });
        
        document.getElementById('msg').innerText = "é€£ç·šåŒæ­¥ä¸­...";
    }

    // --- è¼”åŠ©é‚è¼¯ (åªç”¨æ–¼é¡¯ç¤ºæˆ–è¨ˆç®—) ---
    function isOverheated(x, y) { return gameState.overheated.some(h=>h.x===x && h.y===y); }
    function calcConns(b, r) { let c=[...b]; for(let i=0; i<r; i++) c.unshift(c.pop()); return c; }
    
    function checkMove(x1, y1, x2, y2) {
         if(Math.abs(x1-x2)+Math.abs(y1-y2)!==1) return false;
         let c1 = gameState.board[y1][x1].conns;
         let c2 = gameState.board[y2][x2].conns;
         if(x2>x1) return c1[1]&&c2[3]; if(x2<x1) return c1[3]&&c2[1];
         if(y2>y1) return c1[2]&&c2[0]; if(y2<y1) return c1[0]&&c2[2];
         return false;
    }

    function checkEffect(t) {
        // åƒ…è™•ç†ç°¡å–®æ•ˆæœï¼Œè¤‡é›œå‚³é€éœ€æˆ¿ä¸»é‹ç®—
        if(t.type==='goal') alert("æœ‰äººæŠµé”çµ‚é»ï¼");
        if(t.type==='portal') {
            // é€™è£¡åªåšæç¤ºï¼Œå¯¦éš›å‚³é€ä½ç§»é‚è¼¯æœ€å¥½åœ¨ handleHostLogic è™•ç†ï¼Œé€™è£¡ç‚ºäº†ç¯‡å¹…çœç•¥
            // è‹¥è¦å®Œæ•´ï¼Œéœ€è¦åœ¨ handleHostLogic è£¡åŠ  checkEffect
        }
    }

    // --- åˆå§‹åŒ–æ•¸æ“š (æˆ¿ä¸»ç”¨) ---
    function initGameData() {
        let spec = {lock:0, port:0, curse:0};
        gameState.players = [
            {x:0, y:0}, {x:4, y:0}, {x:0, y:4}, {x:4, y:4}
        ];
        gameState.board = [];
        
        for(let y=0; y<SIZE; y++){
            let row = [];
            for(let x=0; x<SIZE; x++){
                let t = {x,y, type:'norm', base:TILES.I, rot:0, lockedUntil:-1};
                if((x===0||x===4)&&(y===0||y===4)){
                    t.base = TILES.L;
                    if(x===0&&y===0) t.rot=1; if(x===4&&y===0) t.rot=2;
                    if(x===0&&y===4) t.rot=0; if(x===4&&y===4) t.rot=3;
                } else if(x===2&&y===2){t.type='goal'; t.base=TILES.X;}
                else {
                    let r=Math.random();
                    if(r>0.85 && spec.lock<2) { t.type='lock'; spec.lock++; }
                    else if(r>0.75 && spec.port<2) { t.type='portal'; spec.port++; }
                    else if(r>0.6 && spec.curse<2) { t.type='curse'; spec.curse++; }
                    t.base=[TILES.I,TILES.L,TILES.T][Math.floor(Math.random()*3)];
                    t.rot=Math.floor(Math.random()*4);
                }
                t.conns = calcConns(t.base, t.rot);
                row.push(t);
            }
            gameState.board.push(row);
        }
    }

    // è¦–çª—èª¿æ•´é‡ç¹ª
    window.addEventListener('resize', () => {
        if(document.getElementById('game-ui').style.display !== 'none') renderGame();
    });

</script>
</body>
</html>