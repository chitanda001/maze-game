<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è©›å’’è¿·å®®ï¼šçµ‚æ¥µä¿®å¾©ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #1e1e2e; --board: #11111b; --tile: #313244;
            --p1: #f38ba8; --p2: #89b4fa; --p3: #f9e2af; --p4: #a6e3a1;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: #cdd6f4;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* --- å¤§å»³æ¨£å¼ --- */
        #lobby {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1e1e2e; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
            box-sizing: border-box;
        }
        .lobby-box {
            background: #313244; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 { margin: 0 0 20px 0; color: #f9e2af; }
        input {
            width: 100%; padding: 15px; font-size: 1.5rem; text-align: center; letter-spacing: 5px;
            margin-bottom: 15px; border-radius: 8px; border: none; text-transform: uppercase;
            background: #181825; color: white; outline: none; box-sizing: border-box;
        }
        .btn-lobby {
            width: 100%; padding: 15px; font-size: 1.1rem; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; margin-bottom: 10px; color: #111; transition: 0.2s;
        }
        .btn-create { background: #a6e3a1; }
        .btn-join { background: #89b4fa; }
        .room-code { font-size: 3.5rem; font-family: monospace; color: #f9e2af; margin: 15px 0; letter-spacing: 5px; font-weight: bold; }
        .player-list { text-align: left; margin-top: 20px; background: #181825; padding: 10px; border-radius: 8px; }
        .p-item { padding: 8px; border-bottom: 1px solid #45475a; color: #bac2de; }
        .p-item:last-child { border-bottom: none; }

        /* --- éŠæˆ²æ¨£å¼ --- */
        #game-ui { display: none; flex-direction: column; height: 100%; position: relative; }
        
        /* é®ç½© (ç­‰å¾…èˆ‡çµç®—) */
        #wait-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 900;
            display: none; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem; font-weight: bold; flex-direction: column;
            text-align: center;
        }
        
        /* å‹åˆ©ç•«é¢ */
        #win-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 950;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: #f9e2af;
        }
        #win-msg { font-size: 2.5rem; margin-bottom: 20px; animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0%{transform:scale(0);} 100%{transform:scale(1);} }

        header { padding: 10px 15px; background: rgba(0,0,0,0.4); display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0; }
        
        /* --- RWD æ ¸å¿ƒèª¿æ•´å€ --- */
        .game-area { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            padding: 10px;
        }
        
        .board {
            display: grid;
            /* è®“æ£‹ç›¤æ°¸é ä¿æŒæ­£æ–¹å½¢ï¼Œä¸”é©æ‡‰å¯¬åº¦æˆ–é«˜åº¦ï¼Œé¿å…è¶…å‡ºç•«é¢ */
            width: min(92vw, 55vh);
            height: min(92vw, 55vh);
            grid-template-columns: repeat(5, 1fr); 
            grid-template-rows: repeat(5, 1fr);
            gap: 2px; padding: 4px; background: var(--board); border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        /* --------------------- */

        .tile { position: relative; background: var(--tile); border-radius: 4px; transition: transform 0.2s; cursor: pointer; }
        .tile.selected { box-shadow: 0 0 0 3px #89b4fa; z-index: 5; background: #45475a; }
        .tile.overheat { border: 2px dashed #fab387; opacity: 0.5; }
        .tile.locked { border: 2px solid #f38ba8; }
        .tile.locked::after { content:"ğŸ”’"; position:absolute; right:1px; top:1px; font-size:10px; }
        
        .path { position: absolute; background: #bac2de; }
        .path.c { width:40%; height:40%; top:30%; left:30%; }
        .path.n { width:40%; height:35%; top:0; left:30%; }
        .path.s { width:40%; height:35%; bottom:0; left:30%; }
        .path.w { width:35%; height:40%; left:0; top:30%; }
        .path.e { width:35%; height:40%; right:0; top:30%; }
        
        .tile.goal .path { background: #f9e2af; }
        .tile.portal .path { background: #89b4fa; }
        .tile.curse .path { background: #cba6f7; }
        .icon { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:6; font-size:1.2rem; pointer-events:none;}

        .player { position: absolute; width:16%; height:16%; border-radius:50%; z-index:20; border:2px solid #fff; transition:all 0.3s; pointer-events:none; }
        .p0{background:var(--p1);} .p1{background:var(--p2);} .p2{background:var(--p3);} .p3{background:var(--p4);}

        /* åº•éƒ¨æ§åˆ¶å€ RWD å„ªåŒ– */
        .controls { 
            padding: 15px; 
            background: #181825; 
            border-radius: 20px 20px 0 0; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“ */
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        .status-bar { display: flex; justify-content: space-between; color: #a6adc8; font-size: 0.9rem; }
        .msg { text-align: center; color: #fab387; min-height: 1.4em; font-size: 0.95rem;}
        button.game-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-act { background: #a6e3a1; color: #111; }
        .btn-pass { background: #f38ba8; color: #111; }
        .btn-disabled { background: #45475a; color: #777; cursor: not-allowed; }

        /* Badge */
        #turn-badge { padding: 4px 12px; border-radius: 20px; font-weight: bold; background: #333; color: #fff; }
        #my-role { font-weight: bold; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="lobby-box" id="lobby-start">
        <h1>è©›å’’è¿·å®®<br><small style="font-size:1rem; color:#aaa;">æ‰‹æ©Ÿé€£ç·šä¿®å¾©ç‰ˆ</small></h1>
        <button class="btn-lobby btn-create" onclick="createRoom()">ğŸ  æˆ‘æ˜¯æˆ¿ä¸» (å‰µå»º)</button>
        <button class="btn-lobby btn-join" onclick="showJoin()">ğŸ”— æˆ‘æ˜¯ç©å®¶ (åŠ å…¥)</button>
    </div>

    <div class="lobby-box" id="lobby-host" style="display:none;">
        <p style="color:#aaa; margin:0;">æˆ¿é–“ä»£ç¢¼</p>
        <div class="room-code" id="room-id-display">...</div>
        <div class="player-list" id="host-list">
            <div class="p-item">P1 (æˆ¿ä¸») - æº–å‚™</div>
        </div>
        <p style="font-size:0.8rem; color:#666;">ç­‰å¾…æ‰€æœ‰äººåŠ å…¥å¾ŒæŒ‰é–‹å§‹...</p>
        <button class="btn-lobby btn-create" onclick="hostStartGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
    </div>

    <div class="lobby-box" id="lobby-join" style="display:none;">
        <h3>è¼¸å…¥æˆ¿é–“ä»£ç¢¼</h3>
        <input type="text" id="input-room-id" placeholder="ABCD" maxlength="4">
        <button class="btn-lobby btn-join" onclick="joinRoom()">é€£ç·šåŠ å…¥</button>
        <button class="btn-lobby" style="background:#45475a; color:#fff;" onclick="location.reload()">è¿”å›</button>
        <div id="join-status" style="margin-top:10px; color:#f9e2af;"></div>
    </div>
</div>

<div id="game-ui">
    <div id="wait-mask">
        <div style="font-size:3rem; margin-bottom:10px;">â³</div>
        <div id="wait-msg">ç­‰å¾…å°æ‰‹...</div>
    </div>

    <div id="win-screen">
        <div style="font-size:4rem;">ğŸ†</div>
        <div id="win-msg">P1 ç²å‹ï¼</div>
        <div id="host-controls" style="display:none; width: 80%; max-width: 300px;">
            <button class="btn-lobby btn-create" onclick="myAction('RESTART')">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
        <div id="client-wait-restart" style="display:none; color:#aaa; font-size:0.9rem;">
            ç­‰å¾…æˆ¿ä¸»é‡æ–°é–‹å§‹...
        </div>
    </div>

    <header>
        <span id="my-role">æˆ‘æ˜¯: P1</span>
        <span id="turn-badge">P1 å›åˆ</span>
    </header>

    <div class="game-area">
        <div class="board" id="board"></div>
    </div>

    <div class="controls">
        <div class="status-bar">
            <span id="phase-txt">éšæ®µï¼šæ—‹è½‰</span>
            <span id="count-txt" style="color:#a6e3a1; font-weight:bold;">0/2</span>
        </div>
        <div class="msg" id="msg">éŠæˆ²é–‹å§‹</div>
        <div style="display:flex; gap:10px;">
            <button class="game-btn btn-act" id="btn-main" onclick="myAction('CONFIRM')">å®Œæˆæ—‹è½‰</button>
            <button class="game-btn btn-pass" id="btn-sub" onclick="myAction('END')">çµæŸå›åˆ</button>
        </div>
    </div>
</div>

<script>
    // --- éŠæˆ²å¸¸æ•¸ ---
    const SIZE = 5;
    const TILES = { I:[1,0,1,0], L:[0,1,1,0], T:[1,1,1,0], X:[1,1,1,1] };
    const COLORS = ['#f38ba8', '#89b4fa', '#f9e2af', '#a6e3a1'];
    const NAMES = ['P1(ç´…)', 'P2(è—)', 'P3(é»ƒ)', 'P4(ç¶ )'];

    // --- é€£ç·šèˆ‡ç‹€æ…‹ ---
    let peer = null;
    let connections = []; // æˆ¿ä¸»å­˜é€£ç·š
    let hostConn = null;  // ç©å®¶å­˜æˆ¿ä¸»
    let isHost = false;
    let myPlayerIndex = -1; // -1: æœªå®š, 0: P1(æˆ¿ä¸»), 1: P2...

    // éŠæˆ²æ ¸å¿ƒæ•¸æ“š
    let gameState = {
        board: [],
        players: [],
        currP: 0,
        phase: 'ROTATE',
        movesLeft: 0,
        rotatedTiles: [],
        overheated: [],
        turnCount: 0,
        winner: null // æ–°å¢ï¼šå‹åˆ©è€…
    };

    // ===================================
    // 1. PeerJS é€£ç·šé‚è¼¯
    // ===================================

    function generateId() {
        const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let s = ""; for(let i=0;i<4;i++) s+=c.charAt(Math.floor(Math.random()*c.length));
        return s;
    }

    function createRoom() {
        const id = generateId();
        // æˆ¿ä¸» ID æ ¼å¼: CM-ABCD
        initPeer(id);
        isHost = true;
        myPlayerIndex = 0; // æˆ¿ä¸»æ°¸é æ˜¯ P1 (Index 0)
        
        document.getElementById('lobby-start').style.display='none';
        document.getElementById('lobby-host').style.display='block';
        document.getElementById('room-id-display').innerText = id;
    }

    function showJoin() {
        document.getElementById('lobby-start').style.display='none';
        document.getElementById('lobby-join').style.display='block';
    }

    function joinRoom() {
        const input = document.getElementById('input-room-id').value.toUpperCase();
        if(input.length<4) return alert("è«‹è¼¸å…¥4ä½ä»£ç¢¼");
        
        document.getElementById('join-status').innerText = "é€£ç·šä¸­...";
        initPeer(null); // ç©å®¶ ID è‡ªå‹•ç”Ÿæˆ
        
        peer.on('open', (id) => {
            // é€£æ¥æˆ¿ä¸»
            hostConn = peer.connect('CM-' + input);
            
            hostConn.on('open', () => {
                document.getElementById('join-status').innerText = "å·²é€£ç·šï¼ç­‰å¾…æˆ¿ä¸»é–‹å§‹...";
            });

            hostConn.on('data', (data) => {
                if(data.type === 'WELCOME') {
                    myPlayerIndex = Number(data.idx); // ç¢ºä¿æ˜¯æ•¸å­—
                    document.getElementById('join-status').innerText = `æˆ‘æ˜¯ P${myPlayerIndex+1}ï¼Œç­‰å¾…é–‹å§‹...`;
                }
                else if(data.type === 'STATE_UPDATE') {
                    applyState(data.state);
                }
            });

            hostConn.on('close', ()=>alert("æˆ¿ä¸»æ–·ç·šæˆ–æˆ¿é–“å·²é—œé–‰"));
            hostConn.on('error', (err)=>alert("é€£ç·šéŒ¯èª¤: "+err));
        });
    }

    function initPeer(customId) {
        peer = new Peer(customId ? 'CM-'+customId : undefined);
        
        peer.on('connection', (conn) => {
            if(!isHost) return;
            // æˆ¿ä¸»æ¥æ”¶é€£ç·š
            conn.on('open', () => {
                connections.push(conn);
                let newIdx = connections.length; // æˆ¿ä¸»æ˜¯0, ç¬¬ä¸€å€‹é€£ç·šæ˜¯1...
                updateHostLobby();
                // å‘Šè¨´ç©å®¶ä»–æ˜¯å¹¾è™Ÿ
                conn.send({ type:'WELCOME', idx: newIdx });
            });
            conn.on('data', (data) => handleHostLogic(data));
        });
        
        peer.on('error', (err) => {
            if(err.type==='unavailable-id') alert("ä»£ç¢¼é‡è¤‡è«‹é‡è©¦");
            else console.error("Peer Error:", err);
        });
    }

    function updateHostLobby() {
        let html = '<div class="p-item">P1 (æˆ¿ä¸») - æº–å‚™</div>';
        connections.forEach((c,i)=>{
            html += `<div class="p-item">P${i+2} - å·²åŠ å…¥</div>`;
        });
        document.getElementById('host-list').innerHTML = html;
    }

    // ===================================
    // 2. æˆ¿ä¸»é‚è¼¯ (Server Side Logic)
    // ===================================

    function hostStartGame() {
        if(!isHost) return;
        myPlayerIndex = 0;
        initGameData();
        
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        
        broadcastState();
    }

    function handleHostLogic(data) {
        // å¦‚æœæ˜¯é‡å•ŸæŒ‡ä»¤
        if(data.type === 'RESTART' && isHost) {
            hostStartGame();
            return;
        }

        // å¦‚æœéŠæˆ²å·²çµæŸï¼Œåªæ¥å—é‡å•Ÿ
        if(gameState.winner !== null) return;

        let reqPIndex = Number(data.pIndex);
        if(isNaN(reqPIndex) || reqPIndex !== gameState.currP) return;

        let p = gameState.players[gameState.currP];
        if(!p) return;

        if(data.type === 'CLICK') {
            let x=data.x, y=data.y;
            if(y < 0 || y >= SIZE || x < 0 || x >= SIZE) return;
            
            let t = gameState.board[y][x];
            let hasP = gameState.players.some(pl=>pl.x===x && pl.y===y);

            if(gameState.phase==='ROTATE') {
                if(hasP || t.type==='goal' || t.lockedUntil > gameState.turnCount) return; 
                if(isOverheated(x,y)) return; 

                let rotated = gameState.rotatedTiles.some(r=>r.x===x&&r.y===y);
                if(!rotated && gameState.rotatedTiles.length>=2) return; 

                if(!rotated) gameState.rotatedTiles.push({x,y});
                
                t.rot = (t.rot+1)%4;
                t.conns = calcConns(t.base, t.rot);
            }
            else if(gameState.phase==='MOVE') {
                if(gameState.movesLeft>0 && checkMove(p.x, p.y, x, y)) {
                    p.x=x; p.y=y;
                    gameState.movesLeft--;
                    checkEffect(t);
                    // é€™è£¡ç¹¼çºŒåŸ·è¡Œå»£æ’­ï¼Œå› ç‚ºcheckEffectå¯èƒ½æ”¹è®ŠéŠæˆ²ç‹€æ…‹
                }
            }
            else if(gameState.phase==='LOCK') {
                if(t.type!=='goal' && !hasP) {
                    t.lockedUntil = gameState.turnCount+4;
                    hostEndTurn();
                    return; 
                }
            }
        }
        else if(data.type==='CONFIRM') {
            if(gameState.phase==='ROTATE') {
                gameState.overheated = [...gameState.rotatedTiles];
                gameState.phase = 'MOVE';
                // --- ä¿®å¾©é»ï¼šç§»å‹•æ­¥æ•¸æ”¹ç‚º 1 ---
                gameState.movesLeft = 1; 
            }
        }
        else if(data.type==='END') {
            hostEndTurn();
            return;
        }

        broadcastState();
    }

    function hostEndTurn() {
        if(gameState.winner !== null) return;
        gameState.turnCount++;
        gameState.currP = (gameState.currP+1) % 4; 
        gameState.phase = 'ROTATE';
        gameState.movesLeft = 0;
        gameState.rotatedTiles = [];
        broadcastState();
    }

    function broadcastState() {
        renderGame();
        let msg = { type:'STATE_UPDATE', state: gameState };
        connections.forEach(c => {
            if(c && c.open) c.send(msg);
        });
    }

    // ===================================
    // 3. å®¢æˆ¶ç«¯æ¸²æŸ“èˆ‡æ“ä½œ (Client Side)
    // ===================================

    function applyState(newState) {
        gameState = newState;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        renderGame();
    }

    function renderGame() {
        // 1. é ‚éƒ¨è³‡è¨Š
        let roleSpan = document.getElementById('my-role');
        roleSpan.innerText = `æˆ‘æ˜¯: P${myPlayerIndex+1}`;
        roleSpan.style.color = COLORS[myPlayerIndex] || '#fff';

        let turnSpan = document.getElementById('turn-badge');
        let currP = gameState.currP;
        turnSpan.innerText = `${NAMES[currP] || 'æœªçŸ¥'} å›åˆ`;
        turnSpan.style.background = COLORS[currP] || '#777';
        turnSpan.style.color = '#111';

        // 2. è™•ç†éŠæˆ²çµæŸ/ç­‰å¾…é®ç½©
        let mask = document.getElementById('wait-mask');
        let waitMsg = document.getElementById('wait-msg');
        let winScreen = document.getElementById('win-screen');
        
        if(gameState.winner !== null) {
            // --- ä¿®å¾©é»ï¼šé¡¯ç¤ºå‹åˆ©ç•«é¢ï¼Œåœæ­¢æ“ä½œ ---
            mask.style.display = 'none';
            winScreen.style.display = 'flex';
            document.getElementById('win-msg').innerText = `${NAMES[gameState.winner]} ç²å‹ï¼`;
            document.getElementById('win-msg').style.color = COLORS[gameState.winner];
            
            if(isHost) {
                document.getElementById('host-controls').style.display = 'block';
                document.getElementById('client-wait-restart').style.display = 'none';
            } else {
                document.getElementById('host-controls').style.display = 'none';
                document.getElementById('client-wait-restart').style.display = 'block';
            }
        } else {
            winScreen.style.display = 'none';
            // æ­£å¸¸å›åˆé®ç½©
            if(Number(currP) !== Number(myPlayerIndex)) {
                mask.style.display = 'flex';
                waitMsg.innerText = `ç­‰å¾… ${NAMES[currP]} è¡Œå‹•...`;
            } else {
                mask.style.display = 'none';
            }
        }

        // 3. ä¸‹æ–¹æ§åˆ¶åˆ—
        let phTxt = document.getElementById('phase-txt');
        let cnTxt = document.getElementById('count-txt');
        let btnMain = document.getElementById('btn-main');
        let btnSub = document.getElementById('btn-sub');
        let msg = document.getElementById('msg');

        btnMain.onclick = () => myAction('CONFIRM');
        btnSub.onclick = () => myAction('END');

        if(gameState.phase==='ROTATE') {
            phTxt.innerText = "éšæ®µ: æ—‹è½‰";
            cnTxt.innerText = `${gameState.rotatedTiles.length}/2`;
            btnMain.innerText = "å®Œæˆæ—‹è½‰ â–¶";
            btnMain.className = "game-btn btn-act";
            btnMain.disabled = false;
            btnSub.innerText = "çµæŸå›åˆ";
            btnSub.className = "game-btn btn-disabled";
            btnSub.disabled = true;
            msg.innerText = "é»æ“Šæ¿å¡Šæ—‹è½‰ (ä¸å¯è½‰è‡ªå·±è…³ä¸‹)";
        } else if(gameState.phase==='MOVE') {
            phTxt.innerText = "éšæ®µ: ç§»å‹•";
            cnTxt.innerText = `${gameState.movesLeft} æ­¥`;
            btnMain.innerText = "ç§»å‹•ä¸­...";
            btnMain.className = "game-btn btn-disabled";
            btnMain.disabled = true;
            btnSub.className = "game-btn btn-pass";
            btnSub.disabled = false;
            msg.innerText = "é»æ“Šç›¸é„°è·¯å¾‘ç§»å‹•";
        } else { 
            phTxt.innerText = "ç‰¹æ®Š: ä¸Šé–";
            cnTxt.innerText = "--";
            btnMain.className = "game-btn btn-disabled";
            msg.innerText = "é»æ“Šä»»æ„æ¿å¡Šä¸Šé–";
        }

        // 4. ç¹ªè£½æ£‹ç›¤
        const el = document.getElementById('board');
        el.innerHTML = '';
        if(gameState.board && gameState.board.length > 0) {
            gameState.board.forEach(row => row.forEach(t => {
                let div = document.createElement('div');
                div.className = `tile ${t.type}`;
                if(t.lockedUntil > gameState.turnCount) div.classList.add('locked');
                if(isOverheated(t.x, t.y)) div.classList.add('overheat');
                if(gameState.rotatedTiles.some(r=>r.x===t.x&&r.y===t.y)) div.classList.add('selected');

                div.style.transform = `rotate(${t.rot*90}deg)`;
                div.onclick = (e) => {
                    e.stopPropagation(); 
                    myAction('CLICK', {x:t.x, y:t.y});
                };

                let h = '<div class="path c"></div>';
                let c = t.base;
                if(c[0]) h+='<div class="path n"></div>'; if(c[1]) h+='<div class="path e"></div>';
                if(c[2]) h+='<div class="path s"></div>'; if(c[3]) h+='<div class="path w"></div>';
                
                let icon = '';
                if(t.type==='goal') icon='ğŸ’'; else if(t.type==='lock') icon='ğŸ”’';
                else if(t.type==='portal') icon='ğŸŒ€'; else if(t.type==='curse') icon='â˜ ï¸';
                if(icon) h+=`<div class="icon" style="transform:translate(-50%,-50%) rotate(-${t.rot*90}deg)">${icon}</div>`;
                
                div.innerHTML = h;
                el.appendChild(div);
            }));
        }

        // 5. ç¹ªè£½ç©å®¶
        requestAnimationFrame(()=>{
            document.querySelectorAll('.player').forEach(e=>e.remove());
            gameState.players.forEach((p, idx)=>{
                let tiles = document.querySelectorAll('.tile');
                if(p.y*SIZE + p.x < tiles.length) {
                    let targetTile = tiles[p.y*SIZE + p.x];
                    if(targetTile) {
                        let d = document.createElement('div');
                        d.className = `player p${idx}`;
                        let s = targetTile.offsetWidth;
                        d.style.width = (s*0.5)+'px'; d.style.height = (s*0.5)+'px';
                        d.style.left = (targetTile.offsetLeft + s*0.25)+'px';
                        d.style.top = (targetTile.offsetTop + s*0.25)+'px';
                        if(idx === gameState.currP && gameState.winner === null) d.style.boxShadow = "0 0 15px white";
                        el.appendChild(d);
                    }
                }
            });
        });
    }

    function myAction(type, payload) {
        if(myPlayerIndex === -1) return; 
        sendAction(type, payload);
    }

    function sendAction(type, payload) {
        payload = payload || {};
        payload.type = type;
        payload.pIndex = myPlayerIndex; 

        if(isHost) handleHostLogic(payload);
        else if(hostConn && hostConn.open) hostConn.send(payload);
    }

    // --- è¼”åŠ©å‡½å¼ ---
    function isOverheated(x,y) { return gameState.overheated.some(h=>h.x===x && h.y===y); }
    function calcConns(b,r) { let c=[...b]; for(let i=0;i<r;i++) c.unshift(c.pop()); return c; }
    
    function checkMove(x1, y1, x2, y2) {
         if(Math.abs(x1-x2)+Math.abs(y1-y2)!==1) return false;
         if(!gameState.board[y1] || !gameState.board[y2]) return false;
         
         let c1 = gameState.board[y1][x1].conns;
         let c2 = gameState.board[y2][x2].conns;
         if(x2>x1) return c1[1]&&c2[3]; if(x2<x1) return c1[3]&&c2[1];
         if(y2>y1) return c1[2]&&c2[0]; if(y2<y1) return c1[0]&&c2[2];
         return false;
    }

    function checkEffect(t) {
        if(t.type==='goal') { 
            // --- ä¿®å¾©é»ï¼šè¨­å®šå‹åˆ©è€… ---
            gameState.winner = gameState.currP;
            // ç«‹å³åœæ­¢ç§»å‹•ï¼Œç­‰å¾…å»£æ’­
            gameState.movesLeft = 0;
        }
        if(t.type==='curse') {
            setTimeout(()=>{ gameState.movesLeft=0; broadcastState(); alert("â˜ ï¸ è©›å’’è§¸ç™¼ï¼šå¼·åˆ¶åœæ­¢ï¼"); },200);
        }
        if(t.type==='lock') {
            gameState.phase = 'LOCK'; broadcastState();
            alert("ğŸ”’ é–å®šè§¸ç™¼ï¼šè«‹é»æ“Šä¸€å€‹æ¿å¡Šå°‡å…¶é–å®š");
        }
        if(t.type==='portal') {
             setTimeout(()=>{
                 let tx=Math.floor(Math.random()*SIZE), ty=Math.floor(Math.random()*SIZE);
                 while(gameState.board[ty][tx].type==='goal') {
                     tx=Math.floor(Math.random()*SIZE); ty=Math.floor(Math.random()*SIZE);
                 }
                 gameState.players[gameState.currP].x = tx;
                 gameState.players[gameState.currP].y = ty;
                 broadcastState();
                 alert("ğŸŒ€ å‚³é€é–€ï¼ä½ è¢«éš¨æ©Ÿå‚³é€äº†ï¼");
             }, 200);
        }
    }

    function initGameData() {
        let spec = {lock:0, port:0, curse:0};
        gameState.board = [];
        for(let y=0; y<SIZE; y++){
            let row = [];
            for(let x=0; x<SIZE; x++){
                let t = {x,y, type:'norm', base:TILES.I, rot:0, lockedUntil:-1};
                if((x===0||x===4)&&(y===0||y===4)){
                    t.base = TILES.L;
                    if(x===0&&y===0) t.rot=1; if(x===4&&y===0) t.rot=2;
                    if(x===0&&y===4) t.rot=0; if(x===4&&y===4) t.rot=3;
                } else if(x===2&&y===2){t.type='goal'; t.base=TILES.X;}
                else {
                    let r=Math.random();
                    if(r>0.85 && spec.lock<2) { t.type='lock'; spec.lock++; }
                    else if(r>0.75 && spec.port<2) { t.type='portal'; spec.port++; }
                    else if(r>0.6 && spec.curse<2) { t.type='curse'; spec.curse++; }
                    t.base=[TILES.I,TILES.L,TILES.T][Math.floor(Math.random()*3)];
                    t.rot=Math.floor(Math.random()*4);
                }
                t.conns = calcConns(t.base, t.rot);
                row.push(t);
            }
            gameState.board.push(row);
        }
        gameState.players = [{x:0, y:0}, {x:4, y:0}, {x:0, y:4}, {x:4, y:4}];
        gameState.currP = 0;
        gameState.phase = 'ROTATE';
        gameState.movesLeft = 0;
        gameState.rotatedTiles = [];
        gameState.turnCount = 0;
        gameState.winner = null; // é‡ç½®å‹åˆ©è€…
    }

    window.addEventListener('resize', ()=> {
        if(document.getElementById('game-ui').style.display!=='none') renderGame();
    });

</script>
</body>
</html>
